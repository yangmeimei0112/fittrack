<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitTrack - 智慧健康紀錄</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">

    <div id="maintenanceOverlay" class="d-none">
        <img src="https://cdn-icons-png.flaticon.com/512/2581/2581986.png" alt="維修中" class="maintenance-img">
        <h2 class="fw-bold text-dark mb-3">網站維修更新中</h2>
        <p class="text-secondary fs-5">系統正在進行升級，請稍後再試。<br>造成您的不便，敬請見諒。</p>
        <div class="dev-backdoor" onclick="openDevAdmin()">⚙️</div>
    </div>

    <div id="loginTransition">
        <div class="simple-spinner"></div>
        <div class="transition-text" id="transitionText">登入中...</div>
    </div>

    <div class="modal fade" id="systemMessageModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0"><h5 class="modal-title fw-bold" id="msgModalTitle">訊息</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center py-4"><div id="msgModalIcon" class="mb-3 fs-1"></div><p id="msgModalContent" class="fs-5 text-secondary mb-0"></p></div>
                <div class="modal-footer border-0 justify-content-center"><button type="button" class="btn btn-primary px-4 rounded-pill" data-bs-dismiss="modal">確定</button></div>
            </div>
        </div>
    </div>

    <div id="authSection" class="container d-flex justify-content-center align-items-center flex-column" style="min-height: 100vh;">
        <div id="loginCard" class="card shadow-lg border-0 animate-fade-up" style="width: 100%; max-width: 420px;">
            <div class="card-body p-5 text-center">
                <div class="mb-4"><span style="font-size: 3rem;">🏃</span><h2 class="fw-bold text-primary mt-2">FitTrack</h2><p class="text-muted small">高中生運動健康紀錄系統</p></div>
                <form id="loginForm">
                    <div class="form-floating mb-3"><input type="email" class="form-control" id="loginEmail" placeholder="Email" required><label>電子信箱</label></div>
                    <div class="form-floating mb-4"><input type="password" class="form-control" id="loginPassword" placeholder="Password" required><label>密碼</label></div>
                    <button type="submit" class="btn btn-primary w-100 py-3 mb-3">登入系統</button>
                </form>
                <div class="d-flex align-items-center mb-4"><hr class="flex-grow-1"><span class="mx-3 small text-muted">or</span><hr class="flex-grow-1"></div>
                <div class="d-grid gap-2"><button class="btn btn-outline-success btn-sm" onclick="showSignup('student')">註冊「學生」帳號</button><button class="btn btn-outline-danger btn-sm" onclick="showSignup('teacher')">註冊「老師」帳號</button></div>
                <div class="mt-3"><button class="btn btn-light w-100 text-primary fw-bold border" onclick="openCityModal()">🏫 各縣市合作學校快速登入</button></div>
                <div class="mt-4"><a href="#" class="text-muted small text-decoration-none opacity-50" onclick="openDevAdmin()">🔧 開發者管理</a></div>
            </div>
        </div>

        <div id="signupCard" class="card shadow-lg border-0 d-none animate-fade-up" style="width: 100%; max-width: 520px;">
            <div class="card-body p-5">
                <h4 class="fw-bold text-center mb-4" id="signupTitle">註冊</h4>
                <div id="teacherAlert" class="alert alert-warning small d-none"><i class="bi bi-info-circle"></i> 老師帳號需等待管理員審核。</div>
                <form id="signupForm">
                    <input type="hidden" id="signupRole" value="student">
                    <h6 class="text-primary border-bottom pb-2 mb-3"><span class="badge bg-primary me-2">1</span>帳號設定</h6>
                    <div class="row g-2 mb-2"><div class="col-6"><label class="form-label small text-muted">姓名</label><input type="text" class="form-control" id="regName" required></div><div class="col-6"><label class="form-label small text-muted">Email</label><input type="email" class="form-control" id="regEmail" required></div></div>
                    <div class="mb-4"><label class="form-label small text-muted">密碼 (至少6碼)</label><input type="password" class="form-control" id="regPassword" required></div>
                    <div id="studentExtraFields">
                        <h6 class="text-success border-bottom pb-2 mb-3"><span class="badge bg-success me-2">2</span>基本資料</h6>
                        <div class="mb-3"><label class="form-label small text-muted">學校全名</label><input type="text" class="form-control" id="regSchool" placeholder="請填全名 ex.臺北市萬芳高級中學"></div>
                        <div class="row g-2 mb-3"><div class="col-6"><label class="form-label small text-muted">學號</label><input type="text" class="form-control" id="regStudentId"></div><div class="col-6"><label class="form-label small text-muted">年齡</label><input type="number" class="form-control" id="regAge" placeholder="ex. 16"></div></div>
                        <div class="row g-2 mb-3"><div class="col-4"><label class="form-label small text-muted">班級</label><input type="text" class="form-control" id="regClass" placeholder="101"></div><div class="col-4"><label class="form-label small text-muted">座號</label><input type="number" class="form-control" id="regSeat" placeholder="5"></div><div class="col-4"><label class="form-label small text-muted">性別</label><select class="form-select" id="regGender"><option value="male">男</option><option value="female">女</option></select></div></div>
                        <h6 class="text-info border-bottom pb-2 mb-3"><span class="badge bg-info text-dark me-2">3</span>初始數值</h6>
                        <div class="row g-2 mb-4"><div class="col-6"><label class="form-label small text-muted">身高 (cm)</label><input type="number" class="form-control" id="regHeight" step="0.1"></div><div class="col-6"><label class="form-label small text-muted">體重 (kg)</label><input type="number" class="form-control" id="regWeight" step="0.1"></div></div>
                    </div>
                    <button type="submit" class="btn btn-dark w-100 py-2 mb-3" id="signupBtnText">確認註冊</button>
                </form>
                <div class="text-center mt-3"><button class="btn btn-link text-decoration-none text-secondary" onclick="showLogin()">返回登入</button></div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="d-none animate-fade-up">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
            <div class="container-fluid px-4">
                <a class="navbar-brand" href="#">🏃 FitTrack <span id="roleBadge" class="badge bg-warning text-dark ms-2" style="font-size: 0.6em; vertical-align: middle;"></span></a>
                <div class="d-flex align-items-center">
                    <span class="text-white small me-3 user-info-text text-end" id="userEmailDisplay"></span>
                    <button class="btn btn-sm btn-light text-primary fw-bold shadow-sm" onclick="logout()">登出</button>
                </div>
            </div>
        </nav>

        <div class="container mt-4 mb-5">
            <ul class="nav nav-pills mb-4 nav-fill p-1 bg-white rounded shadow-sm" id="pills-tab" role="tablist">
                <li class="nav-item" id="navItemStudent"><button class="nav-link active rounded-pill" id="pills-student-tab" data-bs-toggle="pill" data-bs-target="#pills-student">🧑‍🎓 學生儀表板</button></li>
                <li class="nav-item" id="navItemProfile"><button class="nav-link rounded-pill" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile">👤 個人設定</button></li>
                <li class="nav-item" id="navItemTeacher"><button class="nav-link rounded-pill" id="pills-teacher-tab" data-bs-toggle="pill" data-bs-target="#pills-teacher">👨‍🏫 老師輸入</button></li>
                <li class="nav-item" id="navItemAdmin"><button class="nav-link rounded-pill" id="pills-admin-tab" data-bs-toggle="pill" data-bs-target="#pills-admin">⚙️ 報表管理</button></li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pills-student">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="fw-bold text-dark mb-0">👋 <span id="welcomeName">同學</span>，歡迎回來</h3>
                        <button class="btn btn-primary rounded-pill px-4" onclick="showMyQRCode()">📱 我的 QR Code</button>
                    </div>
                    <select class="form-select d-none" id="studentSelect"><option selected disabled>載入中...</option></select>
                    <div id="qrDisplayArea" class="alert alert-light border text-center d-none mb-4 shadow-sm"><h6 class="text-muted mb-3">請出示給老師掃描</h6><div id="qrcode" class="d-flex justify-content-center"></div></div>
                    <div id="studentStats" class="animate-fade-up">
                        <div class="alert alert-primary bg-opacity-10 border-0 d-flex align-items-center mb-4"><div class="w-100"><h6 class="fw-bold text-primary mb-1">💡 專業建議：</h6><span id="adviceText" class="text-dark">載入中...</span></div></div>
                        <div class="row text-center mb-4 g-3">
                            <div class="col-md-3"><div class="card h-100 p-3"><h6 class="text-muted mb-2">BMI</h6><h2 id="displayBMI" class="fw-bold text-dark">--</h2><span id="badgeBMI" class="badge rounded-pill bg-secondary">--</span></div></div>
                            <div class="col-md-3"><div class="card h-100 p-3"><h6 class="text-muted mb-2">800m</h6><h2 id="displayRun" class="fw-bold text-dark">--</h2><small class="text-muted">秒</small></div></div>
                            <div class="col-md-3"><div class="card h-100 p-3"><h6 class="text-muted mb-2">心率</h6><h2 id="displayHR" class="fw-bold text-dark">--</h2><small class="text-muted">bpm</small></div></div>
                            <div class="col-md-3"><div class="card h-100 p-3"><h6 class="text-muted mb-2">身高</h6><h2 id="displayHeight" class="fw-bold text-dark">--</h2><small class="text-muted">cm</small></div></div>
                        </div>
                        <div class="card p-4 shadow-sm mb-4"><h5 class="card-title fw-bold mb-4">📈 歷史趨勢圖</h5><canvas id="trendChart" height="100"></canvas></div>
                        <div class="card p-4 shadow-sm">
                            <h5 class="card-title fw-bold mb-3">📜 歷史紀錄列表</h5>
                            <div class="table-responsive" style="max-height: 300px;">
                                <table class="table table-hover align-middle">
                                    <thead class="table-light sticky-top"><tr><th>項目</th><th>數值</th><th>單位</th><th>測量時間</th></tr></thead>
                                    <tbody id="studentHistoryTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="pills-profile">
                    <div class="card p-4 shadow-sm mx-auto" style="max-width: 800px;">
                        <h4 class="mb-4 fw-bold text-primary">編輯個人資料</h4>
                        <form id="profileForm">
                            <div class="row g-3">
                                <div class="col-md-6"><label class="form-label small text-muted">姓名</label><input type="text" class="form-control" id="profileName" required></div>
                                <div class="col-md-6"><label class="form-label small text-muted">學號</label><input type="text" class="form-control bg-light" id="profileStudentId" readonly></div>
                                <div class="col-md-12"><label class="form-label small text-muted">學校全名</label><input type="text" class="form-control" id="profileSchool"></div>
                                <div class="col-md-4"><label class="form-label small text-muted">班級</label><input type="text" class="form-control" id="profileClass"></div>
                                <div class="col-md-4"><label class="form-label small text-muted">座號</label><input type="number" class="form-control" id="profileSeat"></div>
                                <div class="col-md-4"><label class="form-label small text-muted">年齡</label><input type="number" class="form-control" id="profileAge"></div>
                                <div class="col-md-6"><label class="form-label fw-bold text-primary">目前身高 (cm)</label><input type="number" class="form-control border-primary" id="profileHeight" step="0.1"></div>
                                <div class="col-md-6"><label class="form-label fw-bold text-primary">目前體重 (kg)</label><input type="number" class="form-control border-primary" id="profileWeight" step="0.1"></div>
                            </div>
                            <div class="mt-3 text-end"><button type="submit" class="btn btn-primary px-4 rounded-pill">💾 儲存修改</button></div>
                        </form>
                    </div>
                </div>

                <div class="tab-pane fade" id="pills-teacher">
                    <div class="row g-4">
                        <div class="col-lg-4">
                            <div class="card p-4 shadow-sm h-100">
                                <h5 class="fw-bold mb-3 text-success">📝 數據輸入</h5>
                                <form id="recordForm">
                                    <div class="mb-3"><label class="form-label small text-muted">選擇學生</label><div class="input-group"><select class="form-select" id="teacherStudentSelect" required></select><button class="btn btn-outline-secondary" type="button" onclick="startScanner()">📷</button></div></div>
                                    <div class="mb-3"><label class="form-label small text-muted">裝置</label><select class="form-select" id="deviceSelect"></select></div>
                                    <div class="row g-2 mb-4">
                                        <div class="col-6"><label class="form-label small text-muted">項目</label><select class="form-select" id="recordType"><option value="height">身高</option><option value="weight">體重</option><option value="run800">800m</option><option value="heartrate">心率</option></select></div>
                                        <div class="col-6"><label class="form-label small text-muted">數值</label><input type="number" class="form-control" id="recordValue" step="0.1" required></div>
                                    </div>
                                    <button type="submit" class="btn btn-success w-100 rounded-pill">💾 儲存並上傳</button>
                                </form>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card p-4 shadow-sm h-100 bg-white">
                                <h5 class="fw-bold mb-3 text-primary">👤 學生資訊</h5>
                                <div id="teacherStudentInfo" class="text-center text-muted py-5"><i class="bi bi-person-bounding-box display-1 text-light"></i><p class="mt-3">請先選擇一位學生</p></div>
                                <div id="teacherStudentDetail" class="d-none animate-fade-up">
                                    <h4 class="fw-bold" id="infoName">姓名</h4>
                                    <p class="text-secondary mb-3"><span id="infoSchool">學校</span> | <span id="infoClass">班</span> <span id="infoSeat">號</span></p>
                                    <hr><h6 class="text-muted small fw-bold">最近 3 筆紀錄</h6><ul class="list-group list-group-flush small" id="infoHistoryList"></ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card p-4 shadow-sm h-100">
                                <h5 class="fw-bold mb-3 text-warning">📊 班級概況</h5>
                                <div class="row text-center mb-3 g-2"><div class="col-4"><div class="p-2 bg-light rounded"><small>均 BMI</small><h4 id="avgBMI">--</h4></div></div><div class="col-4"><div class="p-2 bg-light rounded"><small>均 800m</small><h4 id="avgRun" class="text-danger">--</h4></div></div><div class="col-4"><div class="p-2 bg-light rounded"><small>均 心率</small><h4 id="avgHR" class="text-info">--</h4></div></div></div>
                                <canvas id="classHistogram" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="pills-admin">
                    <div class="card p-4 shadow-sm">
                        <h5 class="fw-bold mb-3 text-dark">資料管理</h5>
                        <div class="row g-3">
                            <div class="col-md-6"><button class="btn btn-dark w-100 h-100 py-3" onclick="exportCSV()">📥 匯出 CSV 報表</button></div>
                            <div class="col-md-6"><input class="form-control mb-2" type="file" id="fhirImportFile"><button class="btn btn-secondary w-100" onclick="importFHIR()">📤 匯入 FHIR</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="cityModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content border-0 shadow"><div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">選擇縣市</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row g-2" id="cityButtonsArea"></div></div></div></div></div>
    <div class="modal fade" id="schoolModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow"><div class="modal-header border-0"><h5 class="modal-title fw-bold" id="selectedCityTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div class="list-group list-group-flush" id="schoolListArea"></div></div></div></div></div>
    <div class="modal fade" id="quickLoginModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow"><div class="modal-header bg-primary text-white"><h5 class="modal-title fw-bold">🏫 快速通關</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><h6 class="text-primary mb-3 fw-bold" id="quickLoginSchoolName"></h6><form id="quickLoginForm"><div class="mb-3"><label class="form-label">班級</label><input type="text" class="form-control" id="quickClass" placeholder="101" required></div><div class="mb-4"><label class="form-label">座號</label><input type="number" class="form-control" id="quickSeat" placeholder="5" required></div><button type="submit" class="btn btn-primary w-100 rounded-pill">🚀 進入系統</button></form></div></div></div></div>
    <div class="modal fade" id="devAdminModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-centered"><div class="modal-content border-0 shadow"><div class="modal-header bg-dark text-white"><h5 class="modal-title fw-bold">🔧 開發者後台</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><div class="card mb-4 border-warning"><div class="card-header bg-warning text-dark fw-bold">🚧 網站維修模式設定</div><div class="card-body"><div class="row"><div class="col-md-3 form-check form-switch ps-5"><input class="form-check-input" type="checkbox" id="maintLogin"><label class="form-check-label">登入畫面</label></div><div class="col-md-3 form-check form-switch ps-5"><input class="form-check-input" type="checkbox" id="maintStudent"><label class="form-check-label">學生主畫面</label></div><div class="col-md-3 form-check form-switch ps-5"><input class="form-check-input" type="checkbox" id="maintTeacher"><label class="form-check-label">老師主畫面</label></div><div class="col-md-3 form-check form-switch ps-5"><input class="form-check-input" type="checkbox" id="maintQuick"><label class="form-check-label">快速登入</label></div></div><button class="btn btn-dark btn-sm mt-3" onclick="saveSystemSettings()">💾 儲存維修設定</button></div></div><div class="d-flex justify-content-between mb-3"><h6 class="fw-bold">使用者列表</h6><button class="btn btn-sm btn-primary" onclick="loadDevUserList()">🔄 刷新</button></div><div class="table-responsive" style="max-height: 400px;"><table class="table table-sm table-hover mb-0 align-middle border"><thead class="table-light sticky-top"><tr><th>身分</th><th>姓名</th><th>學號/Email</th><th>狀態</th><th>操作</th></tr></thead><tbody id="devUserTableBody"></tbody></table></div><hr><button class="btn btn-outline-danger w-100 btn-sm" onclick="generateMockData()">⚡ 生成 30 筆測試學生</button></div></div></div></div>
    <div class="modal fade" id="scannerModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">📷 掃描</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="reader"></div></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
</body>
</html>